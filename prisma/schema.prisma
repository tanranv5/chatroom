// Prisma Schema for Chatroom Application

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 用户表 - 基于 IP 识别
model User {
  id        String    @id @default(cuid())
  ip        String    @unique
  nickname  String    // 根据 IP 地址转换为地理位置作为昵称
  avatar    String    @default("/user-avatar.svg")
  createdAt DateTime  @default(now())
  messages  Message[]
}

// 全局配置表 - 统一管理 API 设置和安全配置
model Settings {
  id              String   @id @default("global")
  imageApiUrl     String   @default("") @db.VarChar(500) // 图像生成 API 端点
  imageApiKey     String   @default("") @db.VarChar(500) // 图像生成 API 密钥
  imageModel      String   @default("") @db.VarChar(200) // 图像生成模型
  speechApiUrl    String   @default("") @db.VarChar(500) // 语音识别 API 端点
  speechApiKey    String   @default("") @db.VarChar(500) // 语音识别 API 密钥
  moderationApiUrl   String @default("") @db.VarChar(500)  // 审查模型 API 端点
  moderationApiKey   String @default("") @db.VarChar(500)  // 审查模型 API 密钥
  moderationModel    String @default("") @db.VarChar(200)  // 审查模型名称
  imagebedUrl     String   @default("") @db.VarChar(500)  // 图床服务地址
  imagebedToken   String   @default("") @db.VarChar(500)  // 图床认证 Token
  adminPassword   String   @default("") @db.VarChar(200)  // 管理密码（哈希存储）
  adminTokenSecret String  @default("") @db.VarChar(200)  // Token 签名密钥
  updatedAt       DateTime @updatedAt
}

// AI 智能体表
model Agent {
  id           String    @id @default(cuid())
  name         String    @db.VarChar(100)
  avatar       String    @db.VarChar(500)
  description  String    @db.Text
  skills       String    @db.Text // 特长描述
  systemPrompt String    @db.Text // 系统提示词
  policyPrompt String?   @db.Text // 安全/行为规则提示词
  isActive     Boolean   @default(true)
  minContentLength  Int  @default(0) // 文案最小字数要求
  minReferenceImages Int @default(0) // 图生图需要的最少参考图数量
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  messages     Message[]
}

// 消息表 - 全部公开可见
model Message {
  id                   String   @id @default(cuid())
  content              String   @db.Text // 用户输入的文本描述
  imageData            String?  @db.LongText // 图片 base64 数据 (生成的图或参考图)
  referenceImagesJson  String?  @db.LongText // 多张参考图 JSON（用于回显与审查，内容可能较大）
  type                 String   @db.VarChar(20) // 'text' | 'image'
  userId               String
  agentId              String
  generationTime       Int?     // 生成耗时(毫秒)
  isPublishedToSquare  Boolean  @default(false) // 是否发布到广场
  userMessageId        String?  // AI 消息关联的用户消息 ID
  createdAt            DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id])
  agent Agent @relation(fields: [agentId], references: [id])

  @@index([agentId])
  @@index([createdAt])
  @@index([isPublishedToSquare])
  @@index([userMessageId])
}
